<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SDL — Shopify Product Import Calculator</title>
  <style>
    :root { --green:#1ea463; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { color: var(--green); }
    textarea { width: 100%; min-height: 160px; }
    .row { margin: 12px 0; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: top; }
    th { background: #f7f7f7; text-align: left; position: sticky; top: 0; z-index: 1; }
    .btn { background: var(--green); color: #fff; padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .btn.secondary { background: #333; }
    .hint { color: #666; font-size: 13px; }
    details { margin: 8px 0; }
    input[type="number"] { width: 90px; }
    .nowrap { white-space: nowrap; }
    .img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #ddd; border-radius: 6px; }
    .tag { display: inline-block; padding: 2px 6px; margin: 2px; background: #eef8f2; border: 1px solid #bbe4cf; border-radius: 12px; font-size: 12px; }
    .flex { display: flex; gap: 12px; align-items: center; }
    .sub { color:#444; font-size:12px; }
  </style>
</head>
<body>
  <h1>SDL — Shopify Product Import Calculator</h1>
  <p class="hint">Paste one product link per line. Default margin <b>45%</b>. We round retail <b>up</b> to the nearest $5 — no cents. You can edit <b>Margin</b> and <b>Box L/W/H (in)</b> per item.</p>

  <div class="row grid">
    <div>
      <label>Product URLs</label>
      <textarea id="links" placeholder="https://www.amazon.com/...&#10;https://lunafurniture.com/..."></textarea>
      <div class="hint">Primary: <b>Zyte</b> • Backup: <b>ChatGPT parsing</b></div>
    </div>
    <div>
      <label>Default Margin (%)</label>
      <div class="flex">
        <input id="margin" type="number" value="45" min="0" max="95" step="1" />
        <span class="hint">Used unless overridden per row.</span>
      </div>
      <details>
        <summary>Advanced</summary>
        <div class="hint">Optional Shopify connection enables auto-collection suggestions.</div>
        <div class="hint">Status: <span id="shopify-status">checking…</span></div>
      </details>
    </div>
  </div>

  <div class="row flex">
    <button class="btn" id="preview">Preview</button>
    <button class="btn secondary" id="download">Export CSV</button>
    <div id="msg" class="hint"></div>
  </div>

  <div id="results"></div>

  <script>
    async function getCollections() {
      try {
        const r = await fetch("/api/collections");
        const j = await r.json();
        const count = (j.custom?.length || 0) + (j.smart?.length || 0);
        document.getElementById("shopify-status").textContent = count ? ("connected ("+count+" collections)") : "not configured";
      } catch {
        document.getElementById("shopify-status").textContent = "not configured";
      }
    }
    getCollections();

    function urlsFromTextarea() {
      const raw = document.getElementById("links").value.trim();
      return raw.split(/[\r\n]+/).map(s => s.trim()).filter(Boolean);
    }

    function h(tag, attrs={}, children=[]) {
      const el = document.createElement(tag);
      for (const k in attrs) {
        if (k === "class") el.className = attrs[k];
        else if (k === "html") el.innerHTML = attrs[k];
        else el.setAttribute(k, attrs[k]);
      }
      for (const c of children) {
        if (typeof c === "string") el.appendChild(document.createTextNode(c));
        else if (c) el.appendChild(c);
      }
      return el;
    }

    let lastPreview = [];

    async function doPreview() {
      const urls = urlsFromTextarea();
      if (!urls.length) {
        document.getElementById("msg").textContent = "Please paste at least one URL.";
        return;
      }
      const marginPercent = Number(document.getElementById("margin").value || 45);
      document.getElementById("msg").textContent = "Scraping and computing…";
      const resp = await fetch("/api/preview", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ urls, marginPercent })
      });
      document.getElementById("msg").textContent = "";
      const data = await resp.json();
      lastPreview = data.items || [];
      renderTable(lastPreview);
    }

    function renderTable(items) {
      const wrap = document.getElementById("results");
      wrap.innerHTML = "";
      if (!items || !items.length) return;

      const table = h("table");
      const thead = h("thead");
      const headRow = h("tr");
      ["Image","Title","Vendor","Cost","Margin %","Retail ($5)","Box L (in)","Box W (in)","Box H (in)","Volume (ft³)","Category","Collections (auto)","Tags","Handle","Source"].forEach(t => headRow.appendChild(h("th",{html:t})));
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = h("tbody");
      items.forEach((it, idx) => {
        const tr = h("tr");

        const img = it.image || (it.images && it.images[0]) || "";
        tr.appendChild(h("td",{},[ img ? h("img",{src:img,class:"img"}) : "" ]));

        tr.appendChild(h("td",{html: it.title || ""}));
        tr.appendChild(h("td",{html: it.vendor || ""}));

        const costIn = h("input",{type:"number", value:String(it.cost||0), step:"1", min:"0"});
        costIn.addEventListener("change", e => {
          lastPreview[idx].cost = Number(e.target.value||0);
          recomputeRow(idx);
        });
        tr.appendChild(h("td",{},[costIn]));

        const mIn = h("input",{type:"number", value:String(it.margin_percent||45), step:"1", min:"0", max:"95"});
        mIn.addEventListener("change", e => {
          lastPreview[idx].margin_percent = Number(e.target.value||45);
          recomputeRow(idx);
        });
        tr.appendChild(h("td",{},[mIn]));

        const retail = h("div",{class:"nowrap", html: "$"+String(it.price_rounded||0)});
        retail.dataset.role = "retail";
        tr.appendChild(h("td",{},[retail]));

        const lIn = h("input",{type:"number", value:String(it.box_length_in||""), step:"0.1", min:"0"});
        const wIn = h("input",{type:"number", value:String(it.box_width_in||""), step:"0.1", min:"0"});
        const hIn = h("input",{type:"number", value:String(it.box_height_in||""), step:"0.1", min:"0"});
        lIn.addEventListener("change", e => { lastPreview[idx].box_length_in = Number(e.target.value||0); recomputeVolume(idx); });
        wIn.addEventListener("change", e => { lastPreview[idx].box_width_in = Number(e.target.value||0); recomputeVolume(idx); });
        hIn.addEventListener("change", e => { lastPreview[idx].box_height_in = Number(e.target.value||0); recomputeVolume(idx); });
        tr.appendChild(h("td",{},[lIn]));
        tr.appendChild(h("td",{},[wIn]));
        tr.appendChild(h("td",{},[hIn]));

        const vol = h("div",{class:"nowrap", html: String(it.box_volume_ft3||"")});
        vol.dataset.role = "vol";
        tr.appendChild(h("td",{},[vol]));

        const catIn = h("input",{type:"text", value: it.product_category || ""});
        catIn.addEventListener("input", e => { lastPreview[idx].product_category = e.target.value; });
        tr.appendChild(h("td",{},[catIn]));

        const coll = h("div",{}, (it.auto_collections||[]).map(c => h("span",{class:"tag"},[c])));
        tr.appendChild(h("td",{},[coll]));

        const tagsIn = h("input",{type:"text", value: (it.tags||[]).join(", ")});
        tagsIn.addEventListener("input", e => { lastPreview[idx].tags = e.target.value.split(",").map(s=>s.trim()).filter(Boolean); });
        tr.appendChild(h("td",{},[tagsIn]));

        tr.appendChild(h("td",{html: it.handle || ""}));
        tr.appendChild(h("td",{},[ h("a",{href:it.source_url,target:"_blank"},["Open"]) ]));

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);

      function recomputeRow(i) {
        const it = lastPreview[i];
        const retail = Math.ceil((Number(it.cost||0)*(1+Number(it.margin_percent||45)/100))/5)*5;
        it.price_rounded = retail;
        wrap.querySelectorAll('div[data-role="retail"]')[i].textContent = "$"+String(retail);
      }
      function recomputeVolume(i) {
        const it = lastPreview[i];
        const l = Number(it.box_length_in||0), w = Number(it.box_width_in||0), h = Number(it.box_height_in||0);
        const vol = l>0&&w>0&&h>0 ? ((l*w*h)/1728).toFixed(3) : "";
        it.box_volume_ft3 = vol ? Number(vol) : "";
        wrap.querySelectorAll('div[data-role="vol"]')[i].textContent = String(it.box_volume_ft3 || "");
      }
    }

    async function exportCsv() {
      const urls = urlsFromTextarea();
      if (!urls.length) {
        document.getElementById("msg").textContent = "Please paste at least one URL.";
        return;
      }
      const overrides = {};
      (lastPreview||[]).forEach(it => {
        overrides[it.handle] = {
          cost: it.cost,
          marginPercent: it.margin_percent,
          product_category: it.product_category,
          type: it.type || "",
          tags: it.tags || [],
          box_length_in: it.box_length_in || "",
          box_width_in: it.box_width_in || "",
          box_height_in: it.box_height_in || ""
        };
      });
      const marginPercent = Number(document.getElementById("margin").value || 45);
      document.getElementById("msg").textContent = "Building CSV…";
      const resp = await fetch("/api/build-csv", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ urls, marginPercent, overrides })
      });
      if (!resp.ok) {
        document.getElementById("msg").textContent = "Error: " + (await resp.text());
        return;
      }
      const blob = await resp.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "sdl_shopify_import.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      document.getElementById("msg").textContent = "CSV downloaded.";
    }

    document.getElementById("preview").addEventListener("click", doPreview);
    document.getElementById("download").addEventListener("click", exportCsv);
  </script>
</body>
</html>
