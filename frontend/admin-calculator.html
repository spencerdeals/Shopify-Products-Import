<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Calculator - SDL Internal Pricing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 50%, #fdbb2d 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[type="number"],
        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.4);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .product-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .product-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .product-info {
            flex: 1;
        }

        .product-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 8px;
        }

        .product-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .boxes-section {
            background: #fff3e0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #ff9800;
        }

        .boxes-section h4 {
            color: #e65100;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .box-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #ffcc80;
            position: relative;
        }

        .box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .box-label {
            font-weight: 600;
            color: #e65100;
        }

        .btn-remove-box {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .box-dimensions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .dimension-field {
            display: flex;
            flex-direction: column;
        }

        .dimension-field label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .dimension-field input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }

        .btn-add-box {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .btn-add-box:hover {
            background: #f57c00;
        }

        .pricing-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .price-row.highlight {
            background: #c8e6c9;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            margin: 8px 0;
        }

        .price-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #1b5e20;
            border-top: 3px solid #4caf50;
            padding-top: 15px;
            margin-top: 15px;
        }

        .margin-editor {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #ffc107;
        }

        .margin-editor label {
            font-size: 13px;
            font-weight: 600;
            color: #f57c00;
            display: block;
            margin-bottom: 8px;
        }

        .margin-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .margin-input-group input {
            width: 120px;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .margin-suggestion {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .review-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .review-table th {
            background: linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .review-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .review-table tr:hover {
            background: #f5f5f5;
        }

        .review-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .collection-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .collection-badge.uncertain {
            background: #fff3e0;
            color: #f57c00;
            border: 2px dashed #ff9800;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .box-dimensions {
                grid-template-columns: repeat(2, 1fr);
            }

            .review-table {
                font-size: 11px;
            }

            .review-table th,
            .review-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Calculator</h1>
            <p>Internal Pricing Tool for SDL</p>
        </div>

        <div class="content">
            <!-- Screen 1: Paste Links -->
            <div id="screen1" class="screen active">
                <h2 class="section-title">Paste Product Links</h2>
                <div class="form-group">
                    <label for="productUrls">Product URLs (one per line)</label>
                    <textarea id="productUrls" rows="12" placeholder="https://www.amazon.com/product-link
https://www.wayfair.com/product-link
https://www.target.com/product-link

Paste your product URLs here..."></textarea>
                </div>
                <button class="btn" onclick="fetchProducts()">Fetch Products</button>
                <button class="btn btn-secondary" onclick="clearAll()">Clear</button>
                <div id="fetchError"></div>
            </div>

            <!-- Screen 2: Dimensions & Costs -->
            <div id="screen2" class="screen">
                <h2 class="section-title">Dimensions & Costs</h2>
                <div id="productsContainer"></div>
                <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                    <button class="btn btn-secondary" onclick="goToScreen(1)">Back</button>
                    <button class="btn btn-success" onclick="goToScreen(3)">Review & Export</button>
                </div>
            </div>

            <!-- Screen 3: Review & Export -->
            <div id="screen3" class="screen">
                <h2 class="section-title">Review & Shopify Export</h2>
                <div id="reviewContainer"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goToScreen(2)">Back</button>
                    <button class="btn btn-success" onclick="exportShopifyCSV()">Download Shopify Products CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [];

        // Dynamic margin rules
        function getDefaultMargin(landedCost) {
            if (landedCost < 200) return 60;
            if (landedCost < 500) return 50;
            if (landedCost < 1000) return 45;
            if (landedCost < 2500) return 40;
            return 38;
        }

        function getMarginTierLabel(landedCost) {
            if (landedCost < 200) return 'Under $200: 60% margin';
            if (landedCost < 500) return '$200-$499: 50% margin';
            if (landedCost < 1000) return '$500-$999: 45% margin';
            if (landedCost < 2500) return '$1,000-$2,499: 40% margin';
            return 'Over $2,500: 38% margin';
        }

        // Round up to next $5
        function roundToNext5(price) {
            return Math.ceil(price / 5) * 5;
        }

        // Auto-assign collection
        function autoAssignCollection(product) {
            const text = `${product.name || ''} ${product.category || ''} ${product.retailer || ''}`.toLowerCase();

            if (text.match(/sofa|sectional|couch|loveseat/)) return { collection: 'Sofas & Sectionals', uncertain: false };
            if (text.match(/chair|armchair|recliner|seating/)) return { collection: 'Chairs & Seating', uncertain: false };
            if (text.match(/table|coffee table|end table|dining table|desk/)) return { collection: 'Tables', uncertain: false };
            if (text.match(/bed|mattress|headboard|nightstand|dresser/)) return { collection: 'Bedroom', uncertain: false };
            if (text.match(/lamp|lighting|chandelier/)) return { collection: 'Lighting', uncertain: false };
            if (text.match(/rug|carpet/)) return { collection: 'Rugs', uncertain: false };
            if (text.match(/decor|mirror|art|vase/)) return { collection: 'Home Decor', uncertain: false };
            if (text.match(/outdoor|patio|garden/)) return { collection: 'Outdoor', uncertain: false };

            return { collection: 'Uncategorized', uncertain: true };
        }

        // Screen navigation
        function goToScreen(screenNumber) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen${screenNumber}`).classList.add('active');

            if (screenNumber === 3) {
                renderReviewScreen();
            }
        }

        // Fetch products
        async function fetchProducts() {
            const urls = document.getElementById('productUrls').value.trim();
            if (!urls) {
                alert('Please enter at least one product URL');
                return;
            }

            const urlList = urls.split('\n').filter(url => url.trim());
            const errorDiv = document.getElementById('fetchError');
            errorDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Scraping products... This may take a moment...</p></div>';

            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urlList })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                products = (data.products || []).map(p => ({
                    ...p,
                    boxes: [{
                        length: p.dimensions?.length || 24,
                        width: p.dimensions?.width || 18,
                        height: p.dimensions?.height || 12,
                        weight: p.weight || 10
                    }],
                    vendor: p.brand || p.retailer || 'Unknown',
                    basePrice: p.price || 0,
                    customMargin: null,
                    // Store additional ZEITS data for CSV export
                    breadcrumbs: p.breadcrumbs || [],
                    descriptionHtml: p.description || '',
                    sku: p.sku || '',
                    variants: p.variantOptions || [],
                    allVariants: p.allVariants || [],
                    rating: p.rating || null,
                    reviews: p.reviews || null,
                    images: p.images || []
                }));

                errorDiv.innerHTML = '';
                goToScreen(2);
                renderProductsScreen();

            } catch (error) {
                console.error('Error fetching products:', error);
                errorDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Render products screen
        function renderProductsScreen() {
            const container = document.getElementById('productsContainer');
            if (!products.length) {
                container.innerHTML = '<div class="error">No products found</div>';
                return;
            }

            container.innerHTML = products.map((product, idx) => `
                <div class="product-card">
                    <div class="product-header">
                        <img src="${product.image || 'https://placehold.co/100x100?text=No+Image'}"
                             alt="${product.name}" class="product-thumbnail">
                        <div class="product-info">
                            <div class="product-title">${product.name || 'Unnamed Product'}</div>
                            <div class="product-meta">
                                <strong>Vendor:</strong>
                                <input type="text" value="${product.vendor}"
                                       onchange="updateProductField(${idx}, 'vendor', this.value)"
                                       style="width: 200px; display: inline-block;">
                            </div>
                            <div class="product-meta"><strong>Source:</strong> ${product.url}</div>
                            <div class="product-meta">
                                <strong>Base Price:</strong> $
                                <input type="number" value="${product.basePrice}" step="0.01" min="0"
                                       onchange="updateProductField(${idx}, 'basePrice', parseFloat(this.value))"
                                       style="width: 100px; display: inline-block;">
                            </div>
                        </div>
                    </div>

                    <div class="boxes-section">
                        <h4>Shipping Boxes</h4>
                        <div id="boxes-${idx}"></div>
                        <button class="btn-add-box" onclick="addBox(${idx})">+ Add Box</button>
                    </div>

                    <div class="margin-editor">
                        <label>Profit Margin (%)</label>
                        <div class="margin-input-group">
                            <input type="number" id="margin-${idx}" step="0.5" min="0" max="100"
                                   onchange="updateMargin(${idx}, parseFloat(this.value))">
                            <span class="margin-suggestion" id="margin-suggestion-${idx}"></span>
                        </div>
                    </div>

                    <div class="pricing-section" id="pricing-${idx}"></div>
                </div>
            `).join('');

            // Render boxes and calculate pricing for each product
            products.forEach((_, idx) => {
                renderBoxes(idx);
                calculatePricing(idx);
            });
        }

        // Render boxes
        function renderBoxes(productIdx) {
            const product = products[productIdx];
            const container = document.getElementById(`boxes-${productIdx}`);

            container.innerHTML = product.boxes.map((box, boxIdx) => `
                <div class="box-item">
                    <div class="box-header">
                        <span class="box-label">Box ${boxIdx + 1}</span>
                        ${product.boxes.length > 1 ? `
                            <button class="btn-remove-box" onclick="removeBox(${productIdx}, ${boxIdx})">Remove</button>
                        ` : ''}
                    </div>
                    <div class="box-dimensions">
                        <div class="dimension-field">
                            <label>Length (in)</label>
                            <input type="number" value="${box.length}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'length', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Width (in)</label>
                            <input type="number" value="${box.width}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'width', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Height (in)</label>
                            <input type="number" value="${box.height}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'height', parseFloat(this.value))">
                        </div>
                        <div class="dimension-field">
                            <label>Weight (lbs)</label>
                            <input type="number" value="${box.weight}" step="0.1" min="0"
                                   onchange="updateBoxDimension(${productIdx}, ${boxIdx}, 'weight', parseFloat(this.value))">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add/remove boxes
        function addBox(productIdx) {
            products[productIdx].boxes.push({ length: 24, width: 18, height: 12, weight: 10 });
            renderBoxes(productIdx);
            calculatePricing(productIdx);
        }

        function removeBox(productIdx, boxIdx) {
            if (products[productIdx].boxes.length > 1) {
                products[productIdx].boxes.splice(boxIdx, 1);
                renderBoxes(productIdx);
                calculatePricing(productIdx);
            }
        }

        // Update box dimension
        function updateBoxDimension(productIdx, boxIdx, field, value) {
            products[productIdx].boxes[boxIdx][field] = value || 0;
            calculatePricing(productIdx);
        }

        // Update product field
        function updateProductField(productIdx, field, value) {
            products[productIdx][field] = value;
            if (field === 'basePrice') {
                calculatePricing(productIdx);
            }
        }

        // Update margin
        function updateMargin(productIdx, value) {
            products[productIdx].customMargin = value > 0 ? value : null;
            calculatePricing(productIdx);
        }

        // Calculate pricing
        function calculatePricing(productIdx) {
            const product = products[productIdx];
            const basePrice = product.basePrice || 0;

            // Calculate total cubic feet from all boxes
            let totalCubicFeet = 0;
            product.boxes.forEach(box => {
                const cubicInches = box.length * box.width * box.height;
                totalCubicFeet += cubicInches / 1728;
            });

            // Freight: $8.50 per cubic foot, $30 minimum
            const freightCost = Math.max(30, totalCubicFeet * 8.5);

            // Duty: 25% of item price
            const dutyAmount = basePrice * 0.25;

            // Wharfage: 1.5% of item price
            const wharfage = basePrice * 0.015;

            // Total landed cost
            const landedCost = basePrice + freightCost + dutyAmount + wharfage;

            // Determine margin
            const defaultMargin = getDefaultMargin(landedCost);
            const marginPercent = product.customMargin !== null ? product.customMargin : defaultMargin;
            const marginAmount = landedCost * (marginPercent / 100);

            // MSRP before rounding
            const msrpBeforeRounding = landedCost + marginAmount;

            // Round UP to next $5
            const msrpRounded = roundToNext5(msrpBeforeRounding);

            // Store calculated values
            product.calculated = {
                totalCubicFeet,
                freightCost,
                dutyAmount,
                wharfage,
                landedCost,
                marginPercent,
                marginAmount,
                msrpBeforeRounding,
                msrpRounded
            };

            // Update margin input
            const marginInput = document.getElementById(`margin-${productIdx}`);
            const marginSuggestion = document.getElementById(`margin-suggestion-${productIdx}`);
            if (marginInput && !marginInput.value) {
                marginInput.value = defaultMargin.toFixed(1);
            }
            if (marginSuggestion) {
                marginSuggestion.textContent = product.customMargin !== null
                    ? `Suggested: ${defaultMargin.toFixed(1)}% (${getMarginTierLabel(landedCost)})`
                    : `Auto: ${getMarginTierLabel(landedCost)}`;
            }

            // Update pricing display
            const pricingDiv = document.getElementById(`pricing-${productIdx}`);
            if (pricingDiv) {
                pricingDiv.innerHTML = `
                    <div class="price-row">
                        <span>Total Cubic Feet (${product.boxes.length} box${product.boxes.length > 1 ? 'es' : ''}):</span>
                        <span>${totalCubicFeet.toFixed(3)} ft³</span>
                    </div>
                    <div class="price-row">
                        <span>Product Price:</span>
                        <span>$${basePrice.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Freight Cost:</span>
                        <span>$${freightCost.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Duty (25%):</span>
                        <span>$${dutyAmount.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Wharfage (1.5%):</span>
                        <span>$${wharfage.toFixed(2)}</span>
                    </div>
                    <div class="price-row highlight">
                        <span>Total Landed Cost:</span>
                        <span>$${landedCost.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>Profit Margin (${marginPercent.toFixed(1)}%):</span>
                        <span>$${marginAmount.toFixed(2)}</span>
                    </div>
                    <div class="price-row">
                        <span>MSRP (before rounding):</span>
                        <span>$${msrpBeforeRounding.toFixed(2)}</span>
                    </div>
                    <div class="price-row total">
                        <span>FINAL MSRP (rounded to $5):</span>
                        <span>$${msrpRounded.toFixed(2)}</span>
                    </div>
                `;
            }
        }

        // Render review screen
        function renderReviewScreen() {
            const container = document.getElementById('reviewContainer');

            const tableRows = products.map((product, idx) => {
                const calc = product.calculated || {};
                const collectionInfo = autoAssignCollection(product);

                // Determine Type from breadcrumbs
                const breadcrumbs = product.breadcrumbs || [];
                const productType = breadcrumbs.length > 0
                    ? (typeof breadcrumbs[breadcrumbs.length - 1] === 'object'
                        ? breadcrumbs[breadcrumbs.length - 1].name
                        : breadcrumbs[breadcrumbs.length - 1])
                    : 'Furniture';

                // Build tags from breadcrumbs and reviews
                let tags = breadcrumbs.map(b => typeof b === 'object' ? b.name : b).join(', ');
                if (product.rating && product.reviews) {
                    tags += tags ? `, ` : '';
                    tags += `Rating: ${product.rating} (${product.reviews} reviews)`;
                }

                return `
                    <tr>
                        <td>${product.name || 'Unnamed'}</td>
                        <td><input type="text" value="${product.vendor}" onchange="products[${idx}].vendor = this.value"></td>
                        <td><input type="text" value="${productType}" onchange="products[${idx}].type = this.value"></td>
                        <td><input type="text" value="${tags}" onchange="products[${idx}].tags = this.value"></td>
                        <td>$${(calc.landedCost || 0).toFixed(2)}</td>
                        <td>${(calc.marginPercent || 0).toFixed(1)}%</td>
                        <td><input type="number" value="${(calc.msrpRounded || 0).toFixed(2)}" step="5" onchange="products[${idx}].calculated.msrpRounded = parseFloat(this.value)"></td>
                        <td><input type="text" value="${product.sku || ''}" onchange="products[${idx}].sku = this.value"></td>
                        <td>
                            <span class="collection-badge ${collectionInfo.uncertain ? 'uncertain' : ''}">
                                ${collectionInfo.collection}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="review-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Vendor</th>
                            <th>Type</th>
                            <th>Tags</th>
                            <th>Landed Cost</th>
                            <th>Margin</th>
                            <th>Price</th>
                            <th>SKU</th>
                            <th>Collection</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        // Export Shopify CSV
        function exportShopifyCSV() {
            if (!products.length) {
                alert('No products to export');
                return;
            }

            const headers = [
                'Handle', 'Title', 'Body (HTML)', 'Vendor', 'Type', 'Tags', 'Published',
                'Option1 Name', 'Option1 Value', 'Variant SKU', 'Variant Grams',
                'Variant Inventory Tracker', 'Variant Inventory Policy', 'Variant Fulfillment Service',
                'Variant Price', 'Variant Compare At Price', 'Variant Requires Shipping',
                'Variant Taxable', 'Image Src', 'Image Position', 'Gift Card',
                'Status', 'Cost per item', 'Collection', 'Collection_Unsure'
            ];

            const rows = [headers];

            products.forEach(product => {
                const calc = product.calculated || {};
                const collectionInfo = autoAssignCollection(product);

                const handle = (product.name || 'product')
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-|-$/g, '');

                // Determine Type from breadcrumbs (leaf node)
                const breadcrumbs = product.breadcrumbs || [];
                const productType = breadcrumbs.length > 0
                    ? (typeof breadcrumbs[breadcrumbs.length - 1] === 'object'
                        ? breadcrumbs[breadcrumbs.length - 1].name
                        : breadcrumbs[breadcrumbs.length - 1])
                    : 'Furniture';

                // Build Tags from full breadcrumb path + rating/reviews
                let tags = breadcrumbs.map(b => typeof b === 'object' ? b.name : b).join(', ');
                if (product.rating && product.reviews) {
                    tags += tags ? ', ' : '';
                    tags += `Rating: ${product.rating} (${product.reviews} reviews)`;
                }

                // Build Body (HTML) with description + canonical link
                let bodyHtml = product.descriptionHtml || product.description || '';
                if (product.url) {
                    bodyHtml += bodyHtml ? '<br><br>' : '';
                    bodyHtml += `<p>Original product: <a href="${product.url}" target="_blank">${product.url}</a></p>`;
                }

                // Extract color variants if available
                const colorVariants = [];
                if (product.variants && product.variants.colors && Array.isArray(product.variants.colors)) {
                    colorVariants.push(...product.variants.colors.map(c => c.value || c));
                } else if (product.allVariants && Array.isArray(product.allVariants)) {
                    // Parse allVariants for color options
                    product.allVariants.forEach(v => {
                        const colorMatch = v.match(/(?:Color|Colour):\s*([^,•|]+)/i);
                        if (colorMatch) {
                            colorVariants.push(colorMatch[1].trim());
                        }
                    });
                }

                // If we have color variants, create multiple rows
                if (colorVariants.length > 0) {
                    colorVariants.forEach((color, colorIdx) => {
                        const variantSku = product.sku ? `${product.sku}-${color.toUpperCase().replace(/\s+/g, '')}` : '';
                        const variantImage = product.images && product.images[colorIdx]
                            ? (product.images[colorIdx].url || product.images[colorIdx])
                            : product.image || '';

                        rows.push([
                            handle,
                            product.name || 'Unnamed Product',
                            bodyHtml,
                            product.vendor || 'SDL',
                            productType,
                            tags,
                            'TRUE',
                            'Color',
                            color,
                            variantSku,
                            product.weight ? Math.round(product.weight * 453.592) : '', // Convert lbs to grams
                            'shopify',
                            'deny',
                            'manual',
                            calc.msrpRounded || 0,
                            '', // Compare At Price (leave blank)
                            'TRUE',
                            'TRUE',
                            variantImage,
                            (colorIdx + 1).toString(),
                            'FALSE',
                            'active',
                            calc.landedCost || 0,
                            collectionInfo.uncertain ? 'REVIEW_COLLECTION' : collectionInfo.collection,
                            collectionInfo.uncertain ? 'TRUE' : 'FALSE'
                        ]);
                    });
                } else {
                    // No variants, single row
                    rows.push([
                        handle,
                        product.name || 'Unnamed Product',
                        bodyHtml,
                        product.vendor || 'SDL',
                        productType,
                        tags,
                        'TRUE',
                        'Title',
                        'Default Title',
                        product.sku || '',
                        product.weight ? Math.round(product.weight * 453.592) : '', // Convert lbs to grams
                        'shopify',
                        'deny',
                        'manual',
                        calc.msrpRounded || 0,
                        '', // Compare At Price (leave blank)
                        'TRUE',
                        'TRUE',
                        product.image || '',
                        '1',
                        'FALSE',
                        'active',
                        calc.landedCost || 0,
                        collectionInfo.uncertain ? 'REVIEW_COLLECTION' : collectionInfo.collection,
                        collectionInfo.uncertain ? 'TRUE' : 'FALSE'
                    ]);
                }
            });

            // Convert to CSV
            const csvContent = rows.map(row =>
                row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',')
            ).join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shopify-products-${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clear all
        function clearAll() {
            products = [];
            document.getElementById('productUrls').value = '';
            goToScreen(1);
        }
    </script>
</body>
</html>
