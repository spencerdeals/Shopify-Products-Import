<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDL Instant Import Calculator - Bermuda Shipping Estimates</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #7cb342 0%, #2e7d32 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #7cb342 0%, #2e7d32 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .input-section {
            margin-bottom: 40px;
        }
        
        .input-section h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .url-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #7cb342;
        }
        
        .btn {
            background: linear-gradient(135deg, #7cb342 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 179, 66, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-test {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            font-size: 14px;
            padding: 10px 20px;
        }
        
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7cb342;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            margin-top: 40px;
        }
        
        .product-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #7cb342;
            position: relative;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .product-info {
            flex: 1;
        }
        
        .product-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .product-retailer {
            background: #7cb342;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .product-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            margin-left: 20px;
        }
        
        .product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .cost-breakdown {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .cost-breakdown h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .cost-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1em;
            color: #2e7d32;
            border-top: 2px solid #7cb342;
            padding-top: 15px;
            margin-top: 10px;
        }
        
        .cost-label {
            color: #666;
        }
        
        .cost-value {
            font-weight: 600;
            color: #333;
        }
        
        .summary {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }
        
        .summary h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-stat {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-stat .value {
            font-size: 1.8em;
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        
        .summary-stat .label {
            color: #666;
            font-size: 14px;
        }
        
        .checkout-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }
        
        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #f44336;
        }
        
        .manual-entry {
            background: #fff3e0;
            border: 2px dashed #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .manual-entry h3 {
            color: #e65100;
            margin-bottom: 10px;
        }
        
        .manual-entry textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            margin: 15px 0;
            resize: vertical;
        }
        
        .confidence-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .product-header {
                flex-direction: column;
            }
            
            .product-image {
                margin: 15px 0 0 0;
                align-self: center;
            }
            
            .product-details {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .test-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¢ SDL Instant Import</h1>
            <p>Calculate shipping costs for importing products to Bermuda</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2>üì¶ Product URLs</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Enter product URLs from Amazon, Wayfair, Target, Best Buy, and other US retailers
                </p>
                
                <!-- Test Buttons -->
                <div class="test-buttons">
                    <button class="btn btn-test" onclick="testCrateAndBarrel()">üß™ Test C&B Loveseat</button>
                    <button class="btn btn-test" onclick="testAmazonMattress()">üß™ Test Amazon Mattress</button>
                    <button class="btn btn-test" onclick="testWayfairSofa()">üß™ Test Wayfair Sofa</button>
                </div>
                
                <textarea 
                    id="urlInput" 
                    class="url-input" 
                    rows="6" 
                    placeholder="https://www.amazon.com/product-link&#10;https://www.wayfair.com/product-link&#10;https://www.target.com/product-link"
                ></textarea>
                
                <button id="calculateBtn" class="btn" onclick="calculateCosts()">
                    üßÆ Calculate Import Costs
                </button>
                
                <button class="btn btn-secondary" onclick="clearResults()">
                    üóëÔ∏è Clear Results
                </button>
            </div>
            
            <div id="loadingSection" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Analyzing products and calculating shipping costs...</p>
            </div>
            
            <div id="resultsSection" class="results" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let currentProducts = [];
        let manualEntryProducts = new Map();

        // Test functions
        function testCrateAndBarrel() {
            document.getElementById('urlInput').value = 'https://www.crateandbarrel.com/retreat-2-piece-chaise-sectional-sofa/s199555';
        }

        function testAmazonMattress() {
            document.getElementById('urlInput').value = 'https://www.amazon.com/Novilla-Mattress-Pocketed-Pressure-Isolation/dp/B0C4LFRZ4X?pd_rd_w=tEZIX&content-id=amzn1.sym.393b97ff-a095-4874-b1c4-ba61ec323005&pf_rd_p=393b97ff-a095-4874-b1c4-ba61ec323005&pf_rd_r=7PEJ79TW9VXMC79P66AE&pd_rd_wg=1Rnr9&pd_rd_r=30d86bdc-9e94-49cc-b8fa-7ef4b3cc67ce&pd_rd_i=B0C4LFRZ4X&ref_=pd_bap_d_grid_rp_0_1_ec_bnp_bia_i&th=1';
        }

        function testWayfairSofa() {
            document.getElementById('urlInput').value = 'https://www.wayfair.com/furniture/pdp/mercury-row-nadine-88-wide-reversible-sofa-chaise-w002662777.html';
        }

        async function calculateCosts() {
            const urlInput = document.getElementById('urlInput');
            const urls = urlInput.value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('Please enter at least one product URL');
                return;
            }
            
            // Show loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('calculateBtn').disabled = true;
            
            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentProducts = data.products || [];
                
                displayResults();
                
            } catch (error) {
                console.error('Error calculating costs:', error);
                document.getElementById('resultsSection').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error</h3>
                        <p>Failed to calculate costs: ${error.message}</p>
                        <p>Please check your internet connection and try again.</p>
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('calculateBtn').disabled = false;
            }
        }

        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            
            if (!currentProducts || currentProducts.length === 0) {
                resultsSection.innerHTML = '<div class="error"><h3>No products found</h3><p>Please check your URLs and try again.</p></div>';
                resultsSection.style.display = 'block';
                return;
            }
            
            let html = '';
            let totalProductCost = 0;
            let totalDuty = 0;
            let totalShipping = 0;
            let deliveryFees = {};
            let hasManualEntry = false;
            
            // Process each product
            currentProducts.forEach((product, index) => {
                if (product.manualEntryRequired) {
                    hasManualEntry = true;
                    html += createManualEntryCard(product, index);
                    return;
                }
                
                const productCost = product.price || 0;
                const dutyAmount = productCost * 0.265;
                const shippingCost = calculateShippingCost(product.dimensions, product.weight, productCost);
                
                totalProductCost += productCost;
                totalDuty += dutyAmount;
                totalShipping += shippingCost;
                
                // Track delivery fees by retailer
                if (!deliveryFees[product.retailer]) {
                    deliveryFees[product.retailer] = 25;
                }
                
                html += createProductCard(product, productCost, dutyAmount, shippingCost, index);
            });
            
            // Add delivery fees to total
            const totalDeliveryFees = Object.values(deliveryFees).reduce((sum, fee) => sum + fee, 0);
            const grandTotal = totalProductCost + totalDuty + totalShipping + totalDeliveryFees;
            
            // Add summary if we have valid products
            if (totalProductCost > 0) {
                html += createSummary(totalProductCost, totalDuty, totalShipping, totalDeliveryFees, grandTotal, deliveryFees);
            }
            
            resultsSection.innerHTML = html;
            resultsSection.style.display = 'block';
        }

        function calculateShippingCost(dimensions, weight, price) {
            if (!dimensions) {
                return Math.max(25, price * 0.15);
            }
            
            // Calculate volume in cubic feet
            const cubicInches = dimensions.length * dimensions.width * dimensions.height;
            const cubicFeet = cubicInches / 1728;
            
            // Base shipping cost: $8 per cubic foot, minimum $15
            const baseCost = Math.max(15, cubicFeet * 8);
            
            // Add handling fee
            const handlingFee = 15;
            const baseShippingCost = baseCost + handlingFee;
            
            // Calculate total landed cost before margin
            const dutyAmount = price * 0.265;
            const deliveryFee = 25;
            const landedCostBeforeMargin = price + dutyAmount + baseShippingCost + deliveryFee;
            
            // Calculate 20% margin on total landed cost
            const margin = landedCostBeforeMargin * 0.20;
            
            // Add margin to shipping cost (margin is hidden in shipping)
            const finalShippingCost = baseShippingCost + margin;
            
            return Math.round(finalShippingCost);
        }

        function createProductCard(product, productCost, dutyAmount, shippingCost, index) {
            const confidenceBadge = product.confidence ? 
                `<div class="confidence-badge confidence-${getConfidenceLevel(product.confidence)}">
                    ${(product.confidence * 100).toFixed(1)}% confidence
                </div>` : '';
            
            return `
                <div class="product-card">
                    ${confidenceBadge}
                    <div class="product-header">
                        <div class="product-info">
                            <div class="product-retailer">${product.retailer}</div>
                            <div class="product-name">${product.name || 'Unknown Product'}</div>
                        </div>
                        ${product.image ? `<img src="${product.image}" alt="Product" class="product-image" onerror="this.src='https://placehold.co/120x120/7CB342/FFFFFF/png?text=SDL'">` : ''}
                    </div>
                    
                    <div class="product-details">
                        <div class="detail-item">
                            <div class="detail-label">Price</div>
                            <div class="detail-value">$${productCost.toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Dimensions</div>
                            <div class="detail-value">${formatDimensions(product.dimensions)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Weight</div>
                            <div class="detail-value">${product.weight ? product.weight.toFixed(1) + ' lbs' : 'Estimated'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${product.category || 'General'}</div>
                        </div>
                    </div>
                    
                    <div class="cost-breakdown">
                        <h3>üí∞ Cost Breakdown</h3>
                        <div class="cost-item">
                            <span class="cost-label">Item Cost:</span>
                            <span class="cost-value">$${productCost.toFixed(2)} (1x $${productCost.toFixed(2)})</span>
                        </div>
                        <div class="cost-item">
                            <span class="cost-label">Import Duty (26.5%):</span>
                            <span class="cost-value">$${dutyAmount.toFixed(2)}</span>
                        </div>
                        <div class="cost-item">
                            <span class="cost-label">Shipping & Handling:</span>
                            <span class="cost-value">$${shippingCost.toFixed(2)}</span>
                        </div>
                        <div class="cost-item">
                            <span class="cost-label">Total Landed Cost:</span>
                            <span class="cost-value">$${(productCost + dutyAmount + shippingCost).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function createManualEntryCard(product, index) {
            return `
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-info">
                            <div class="product-retailer">${product.retailer}</div>
                            <div class="product-name">Manual Entry Required</div>
                        </div>
                    </div>
                    
                    <div class="manual-entry">
                        <h3>üîß Manual Processing Required</h3>
                        <p>${product.message}</p>
                        <p><strong>Instructions:</strong></p>
                        <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
                            <li>Visit the product page: <a href="${product.url}" target="_blank">Open Product Page</a></li>
                            <li>Copy the entire webpage content (Ctrl+A, then Ctrl+C)</li>
                            <li>Paste it in the box below</li>
                            <li>Click "Process Content" to extract product information</li>
                        </ol>
                        <textarea id="manualContent_${index}" placeholder="Paste the webpage content here..."></textarea>
                        <button class="btn" onclick="processManualContent(${index}, '${product.url}')">
                            ü§ñ Process Content
                        </button>
                        <div id="manualResult_${index}"></div>
                    </div>
                </div>
            `;
        }

        async function processManualContent(index, url) {
            const content = document.getElementById(`manualContent_${index}`).value.trim();
            const resultDiv = document.getElementById(`manualResult_${index}`);
            
            if (!content) {
                resultDiv.innerHTML = '<div class="error">Please paste the webpage content first.</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing content...</p></div>';
            
            try {
                const response = await fetch('/api/process-manual-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, htmlContent: content })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Processing failed');
                }
                
                const result = await response.json();
                
                if (result.success && result.product) {
                    // Replace the manual entry product with the processed one
                    currentProducts[index] = result.product;
                    manualEntryProducts.set(index, result.product);
                    
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <h4>‚úÖ Successfully Processed!</h4>
                            <p><strong>Product:</strong> ${result.product.name}</p>
                            <p><strong>Price:</strong> $${result.product.price}</p>
                            <button class="btn" onclick="displayResults()" style="margin-top: 10px;">
                                üîÑ Update Results
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error('No product data received');
                }
                
            } catch (error) {
                console.error('Manual processing error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Processing Failed</h4>
                        <p>${error.message}</p>
                        <p>Please try copying the webpage content again, making sure to include the product name and price.</p>
                    </div>
                `;
            }
        }

        function createSummary(totalProductCost, totalDuty, totalShipping, totalDeliveryFees, grandTotal, deliveryFees) {
            const productCount = currentProducts.filter(p => !p.manualEntryRequired && p.price).length;
            
            return `
                <div class="summary">
                    <h2>üìä Import Summary</h2>
                    
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="value">${productCount}</div>
                            <div class="label">Products</div>
                        </div>
                        <div class="summary-stat">
                            <div class="value">$${totalProductCost.toFixed(2)}</div>
                            <div class="label">Product Cost</div>
                        </div>
                        <div class="summary-stat">
                            <div class="value">$${totalDuty.toFixed(2)}</div>
                            <div class="label">Import Duty</div>
                        </div>
                        <div class="summary-stat">
                            <div class="value">$${totalShipping.toFixed(2)}</div>
                            <div class="label">Shipping</div>
                        </div>
                        <div class="summary-stat">
                            <div class="value">$${totalDeliveryFees.toFixed(2)}</div>
                            <div class="label">Delivery Fees</div>
                        </div>
                        <div class="summary-stat">
                            <div class="value">$${grandTotal.toFixed(2)}</div>
                            <div class="label">Total Cost</div>
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: left;">
                        <h3 style="color: #2e7d32; margin-bottom: 15px;">üí≥ Payment Breakdown</h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span>Products Total:</span>
                                <span style="font-weight: 600;">$${totalProductCost.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span>Bermuda Duty + Wharfage (26.5%):</span>
                                <span style="font-weight: 600;">$${totalDuty.toFixed(2)}</span>
                            </div>
                            ${Object.entries(deliveryFees).map(([retailer, fee]) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <span>${retailer} US Delivery Fee:</span>
                                    <span style="font-weight: 600;">$${fee.toFixed(2)}</span>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span>Shipping & Handling to Bermuda:</span>
                                <span style="font-weight: 600;">$${totalShipping.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 15px 0 8px 0; border-top: 2px solid #7cb342; font-size: 1.2em; font-weight: 700; color: #2e7d32;">
                                <span>TOTAL:</span>
                                <span>$${grandTotal.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="checkout-btn" onclick="proceedToCheckout()">
                        üõí Create Import Order - $${grandTotal.toFixed(2)}
                    </button>
                    
                    <p style="margin-top: 20px; font-size: 14px; color: #666;">
                        * Estimated delivery time: 3-5 weeks via ocean freight<br>
                        * All duties and taxes included in final price
                    </p>
                </div>
            `;
        }

        async function proceedToCheckout() {
            // Filter out manual entry products that haven't been processed
            const validProducts = currentProducts.filter(p => !p.manualEntryRequired && p.price > 0);
            
            if (validProducts.length === 0) {
                alert('No valid products to checkout. Please ensure all products have been processed.');
                return;
            }
            
            // Calculate totals
            let totalProductCost = 0;
            let totalDuty = 0;
            let totalShipping = 0;
            let deliveryFees = {};
            
            validProducts.forEach(product => {
                const productCost = product.price;
                const dutyAmount = productCost * 0.265;
                const shippingCost = calculateShippingCost(product.dimensions, product.weight, productCost);
                
                totalProductCost += productCost;
                totalDuty += dutyAmount;
                totalShipping += shippingCost;
                
                if (!deliveryFees[product.retailer]) {
                    deliveryFees[product.retailer] = 25;
                }
            });
            
            const totalDeliveryFees = Object.values(deliveryFees).reduce((sum, fee) => sum + fee, 0);
            const grandTotal = totalProductCost + totalDuty + totalShipping + totalDeliveryFees;
            
            // Prepare order data
            const orderData = {
                products: validProducts,
                deliveryFees: deliveryFees,
                totals: {
                    productCost: totalProductCost,
                    dutyAmount: totalDuty,
                    shippingCost: totalShipping,
                    totalShippingCost: totalShipping,
                    deliveryFees: totalDeliveryFees,
                    grandTotal: grandTotal
                },
                originalUrls: document.getElementById('urlInput').value
            };
            
            try {
                // Store the order temporarily
                const response = await fetch('/api/store-pending-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to store order data');
                }
                
                const result = await response.json();
                
                // Redirect to completion page
                window.location.href = `/complete-order.html?checkoutId=${result.orderId}`;
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to proceed to checkout. Please try again.');
            }
        }

        function formatDimensions(dimensions) {
            if (!dimensions) return 'Estimated';
            return `${dimensions.length}" √ó ${dimensions.width}" √ó ${dimensions.height}"`;
        }

        function getConfidenceLevel(confidence) {
            if (confidence >= 0.8) return 'high';
            if (confidence >= 0.5) return 'medium';
            return 'low';
        }

        function clearResults() {
            document.getElementById('urlInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            currentProducts = [];
            manualEntryProducts.clear();
        }
    </script>
</body>
</html>