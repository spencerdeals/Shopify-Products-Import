<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Import Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #7cb342 0%, #2e7d32 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
            min-height: 500px;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #7cb342 0%, #2e7d32 100%);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-size: 14px;
        }

        /* Progress indicator */
        .progress-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .progress-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 8px;
        }

        .progress-circle.active {
            background-color: #7cb342;
            color: white;
        }

        .progress-circle.completed {
            background-color: #4caf50;
            color: white;
        }

        .progress-line {
            width: 40px;
            height: 2px;
            background-color: #e0e0e0;
            margin: 0 5px;
        }

        .progress-line.completed {
            background-color: #4caf50;
        }

        /* Warning boxes - now orange/yellow */
        .warning-box {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid #ffa726;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            position: relative;
        }

        .warning-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #e65100;
            font-weight: 600;
            font-size: 15px;
        }

        .warning-header::before {
            content: '‚ö†Ô∏è';
            margin-right: 8px;
            font-size: 18px;
        }

        .warning-text {
            color: #bf360c;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Freight Forwarder Address Box */
        .forwarder-address {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 2px solid #66bb6a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
        }

        .forwarder-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            color: #2e7d32;
            font-weight: 600;
            font-size: 16px;
        }

        .forwarder-header::before {
            content: 'üöö';
            margin-right: 8px;
            font-size: 20px;
        }

        .forwarder-name {
            color: #2e7d32;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .forwarder-details {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .forwarder-note {
            color: #558b2f;
            font-style: italic;
            font-size: 13px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #a5d6a7;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f8f9fa;
            font-family: inherit;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #7cb342;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(124, 179, 66, 0.1);
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 10px 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .secondary-btn {
            background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%);
        }

        /* Vendor group styling */
        .vendor-group {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #ba68c8;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .vendor-header {
            color: #6a1b9a;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .vendor-header::before {
            content: 'üè™';
            margin-right: 10px;
            font-size: 22px;
        }

        .product-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ba68c8;
        }

        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .product-details {
            font-size: 13px;
            color: #666;
        }

        .delivery-fee-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ba68c8;
            margin-top: 15px;
        }

        .delivery-fee-input input {
            background: white;
        }

        /* Final summary styling */
        .cost-breakdown {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .cost-item:last-child {
            border-bottom: none;
        }

        .cost-label {
            color: #555;
            font-size: 14px;
        }

        .cost-value {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .total-row {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #7cb342;
            background: rgba(124, 179, 66, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .total-row .cost-label {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .total-row .cost-value {
            font-size: 20px;
            color: #7cb342;
            font-weight: 700;
        }

        /* Confirmation checkbox */
        .confirmation-checkbox {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .checkbox-container input[type="checkbox"] {
            margin-top: 4px;
            width: auto;
            flex-shrink: 0;
        }

        .checkbox-label {
            color: #e65100;
            font-size: 14px;
            line-height: 1.5;
            cursor: pointer;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7cb342;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        .error {
            display: none;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .error.active {
            display: block;
        }

        .info-text {
            color: #666;
            font-size: 12px;
            text-align: center;
            margin-top: 20px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SDL Instant Imports (Ocean Freight)</h1>
        <p class="subtitle">Get accurate shipping costs for your Bermuda imports</p>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step">
                <div class="progress-circle active" id="step1">1</div>
                <span>Add Products</span>
            </div>
            <div class="progress-line" id="line1"></div>
            <div class="progress-step">
                <div class="progress-circle" id="step2">2</div>
                <span>Review & Fees</span>
            </div>
            <div class="progress-line" id="line2"></div>
            <div class="progress-step">
                <div class="progress-circle" id="step3">3</div>
                <span>Confirm Order</span>
            </div>
        </div>

        <!-- PAGE 1: URL Input -->
        <div class="page active" id="page1">
            <div class="warning-box">
                <div class="warning-header">Please Note</div>
                <div class="warning-text">
                    Before pasting your links, make sure you've selected the correct size, color, or variant on each product page. We can't be responsible for mix-ups if the wrong variant gets ordered! üòä
                </div>
            </div>

            <form id="urlForm">
                <div class="input-group">
                    <label for="productUrls">Product URLs</label>
                    <textarea 
                        id="productUrls" 
                        name="productUrls" 
                        placeholder="Paste your product URLs here, one per line:
https://www.amazon.com/product1
https://www.wayfair.com/product2
https://www.target.com/product3

You can add as many as you'd like!"
                        required
                    ></textarea>
                </div>

                <div class="button-group">
                    <div></div> <!-- Empty div for spacing -->
                    <button type="submit">Continue to Review ‚Üí</button>
                </div>
            </form>
        </div>

        <!-- PAGE 2: Review Products & Delivery Fees -->
        <div class="page" id="page2">
            <h2 style="margin-bottom: 20px; color: #333;">Review Your Products</h2>
            
            <!-- Freight Forwarder Address Box -->
            <div class="forwarder-address">
                <div class="forwarder-header">USA Freight Forwarder Address</div>
                <div class="forwarder-name">Sealine Freight Forwarder</div>
                <div class="forwarder-details">
                    Elizabeth, NJ 07201-614<br>
                    New Jersey, USA
                </div>
                <div class="forwarder-note">
                    Use this address when calculating shipping costs from US retailers to get accurate delivery totals.
                </div>
            </div>

            <div id="vendorGroups"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Searching for product information...</div>
            </div>

            <div class="error" id="error"></div>

            <div class="button-group">
                <button type="button" class="secondary-btn" onclick="goToPage(1)">‚Üê Back to Products</button>
                <button type="button" id="continueToFinal" onclick="calculateAndProceed()" disabled>Calculate Total ‚Üí</button>
            </div>
        </div>

        <!-- PAGE 3: Final Breakdown & Confirmation -->
        <div class="page" id="page3">
            <h2 style="margin-bottom: 20px; color: #333;">Final Cost Breakdown</h2>
            
            <div class="cost-breakdown" id="costBreakdown"></div>

            <div class="confirmation-checkbox">
                <div class="checkbox-container">
                    <input type="checkbox" id="confirmVariants">
                    <label for="confirmVariants" class="checkbox-label">
                        I confirm I have double-checked that all product links have the correct sizes, colors, and variants selected. SDL will not be responsible for customer errors if the wrong items are ordered. Let's keep this simple and fun! ‚úÖ
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="secondary-btn" onclick="goToPage(2)">‚Üê Back to Review</button>
                <button type="button" id="createOrderBtn" onclick="createDraftOrder()" disabled>Confirm & Create Order üéâ</button>
            </div>
        </div>

        <p class="info-text" id="infoText">
            This calculator uses intelligent estimation to determine shipping costs based on product category, weight, and price.
            We search multiple data points to provide the most accurate estimate possible.
        </p>
    </div>

    <script>
        let currentPage = 1;
        let scrapedProducts = [];
        let vendorGroups = {};
        let finalCalculation = null;

        // Page navigation
        function goToPage(pageNumber) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(`page${pageNumber}`).classList.add('active');
            
            // Update progress bar
            updateProgressBar(pageNumber);
            
            currentPage = pageNumber;
        }

        function updateProgressBar(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                const line = document.getElementById(`line${i}`);
                
                if (i < activeStep) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    if (line) line.classList.add('completed');
                } else if (i === activeStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                    if (line) line.classList.remove('completed');
                }
            }
        }

        // Form submission for URLs
        document.getElementById('urlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const urls = document.getElementById('productUrls').value
                .split('\n')
                .map(url => url.trim())
                .filter(url => url && url.startsWith('http'));
            
            if (urls.length === 0) {
                alert('Please enter at least one valid product URL');
                return;
            }
            
            // Go to page 2 and start scraping
            goToPage(2);
            await scrapeProducts(urls);
        });

        // Scrape products
        async function scrapeProducts(urls) {
            document.getElementById('loading').classList.add('active');
            
            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ urls })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to scrape products');
                }
                
                const data = await response.json();
                scrapedProducts = data.products || [];
                vendorGroups = groupProductsByVendor(scrapedProducts);
                
                displayVendorGroups();
                document.getElementById('loading').classList.remove('active');
                document.getElementById('continueToFinal').disabled = false;
                
            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('error').classList.add('active');
                document.getElementById('error').textContent = 'Failed to load products. Please check your URLs and try again.';
            }
        }

        // Group products by vendor
        function groupProductsByVendor(products) {
            const groups = {};
            products.forEach(product => {
                const vendor = product.retailer || 'Unknown';
                if (!groups[vendor]) {
                    groups[vendor] = [];
                }
                groups[vendor].push(product);
            });
            return groups;
        }

        // Display vendor groups
        function displayVendorGroups() {
            const container = document.getElementById('vendorGroups');
            container.innerHTML = '';
            
            Object.entries(vendorGroups).forEach(([vendor, products]) => {
                const vendorDiv = document.createElement('div');
                vendorDiv.className = 'vendor-group';
                
                vendorDiv.innerHTML = `
                    <div class="vendor-header">${vendor} Products</div>
                    ${products.map(product => `
                        <div class="product-item">
                            <div class="product-name">${product.name}</div>
                            <div class="product-details">
                                Price: ${product.price ? '$' + product.price : 'Price detection needed'} | 
                                Category: ${product.category} | 
                                Estimated shipping: $${product.shippingCost || 0}
                            </div>
                        </div>
                    `).join('')}
                    <div class="delivery-fee-input">
                        <label for="delivery-${vendor}">
                            <strong>${vendor} Delivery Fee (if any):</strong><br>
                            <small>Enter any shipping charges from ${vendor} to our New Jersey address:</small>
                        </label>
                        <div style="display: flex; align-items: center; margin-top: 8px;">
                            <span style="margin-right: 10px;">$</span>
                            <input type="number" id="delivery-${vendor}" step="0.01" min="0" value="0" placeholder="0.00">
                        </div>
                    </div>
                `;
                
                container.appendChild(vendorDiv);
            });
        }

        // Calculate and proceed to final page
        async function calculateAndProceed() {
            // Collect delivery fees
            const deliveryFees = {};
            Object.keys(vendorGroups).forEach(vendor => {
                const input = document.getElementById(`delivery-${vendor}`);
                deliveryFees[vendor] = parseFloat(input.value) || 0;
            });
            
            // Calculate totals
            const calculation = calculateTotals(deliveryFees);
            finalCalculation = calculation;
            
            displayFinalBreakdown(calculation);
            goToPage(3);
        }

        // Calculate totals
        function calculateTotals(deliveryFees) {
            let totalItemCost = 0;
            let totalShippingCost = 0;
            let totalDeliveryFees = 0;
            
            scrapedProducts.forEach(product => {
                totalItemCost += product.price || 0;
                totalShippingCost += product.shippingCost || 0;
            });
            
            Object.values(deliveryFees).forEach(fee => {
                totalDeliveryFees += fee;
            });
            
            const dutyAmount = totalItemCost * 0.265; // 26.5% duty
            const grandTotal = totalItemCost + dutyAmount + totalDeliveryFees + totalShippingCost;
            
            return {
                products: scrapedProducts,
                deliveryFees,
                totals: {
                    totalItemCost,
                    dutyAmount,
                    totalDeliveryFees,
                    totalShippingCost,
                    grandTotal
                },
                originalUrls: document.getElementById('productUrls').value
                    .split('\n')
                    .map(url => url.trim())
                    .filter(url => url && url.startsWith('http'))
            };
        }

        // Display final breakdown
        function displayFinalBreakdown(calculation) {
            const container = document.getElementById('costBreakdown');
            const { totals } = calculation;
            
            container.innerHTML = `
                <div class="cost-item">
                    <span class="cost-label">Item First Cost:</span>
                    <span class="cost-value">$${totals.totalItemCost.toFixed(2)}</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Bermuda Import Duty (26.5%):</span>
                    <span class="cost-value">$${totals.dutyAmount.toFixed(2)}</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">USA Delivery Fees:</span>
                    <span class="cost-value">$${totals.totalDeliveryFees.toFixed(2)}</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Ocean Freight & Handling:</span>
                    <span class="cost-value">$${totals.totalShippingCost.toFixed(2)}</span>
                </div>
                <div class="cost-item total-row">
                    <span class="cost-label">Total Landed Cost:</span>
                    <span class="cost-value">$${totals.grandTotal.toFixed(2)}</span>
                </div>
            `;
        }

        // Confirmation checkbox handling
        document.getElementById('confirmVariants').addEventListener('change', function() {
            document.getElementById('createOrderBtn').disabled = !this.checked;
        });

        // Create draft order
        async function createDraftOrder() {
            if (!finalCalculation) return;
            
            const btn = document.getElementById('createOrderBtn');
            btn.disabled = true;
            btn.textContent = 'Creating Order...';
            
            // Add customer info (you might want to collect this earlier)
            const customerEmail = prompt('Please enter customer email:');
            const customerName = prompt('Please enter customer name:');
            
            if (!customerEmail || !customerName) {
                alert('Customer information is required');
                btn.disabled = false;
                btn.textContent = 'Confirm & Create Order';
                return;
            }
            
            finalCalculation.customer = {
                email: customerEmail,
                name: customerName
            };
            
            try {
                const response = await fetch('/apps/instant-import/create-draft-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(finalCalculation)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create draft order');
                }
                
                const data = await response.json();
                
                // Go to thank you page instead of alert
                goToPage(4);
                
            } catch (error) {
                alert('Failed to create draft order. Please try again.');
                btn.textContent = 'Confirm & Create Order';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
